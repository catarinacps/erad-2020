#+TITLE:     Análise da Influência do Runtime OpenMP no Desempenho de Aplicação com Tarefas
#+AUTHOR:    Henrique C. P. da Silva, *Marcelo C. Milletto*, Vinicius G. Pinto, Lucas M. Schnorr \linebreak {hcpsilva,marcelo.miletto,vgpinto,schnorr}@inf.ufrgs.br
#+EMAIL:     {marcelo.miletto, schnorr}@inf.ufrgs.br
#+DATE:      ERAD 2020 - Abril 15-17

#+LANGUAGE:  en
#+OPTIONS:   H:2 num:t toc:t \n:nil ::t |:t ^:t -:t f:t *:t tex:t d:(HIDE) tags:not-in-toc <:t
#+OPTIONS:   d:nil todo:t pri:nil
#+TAGS: noexport(n) deprecated(d) ignore(i)
#+STARTUP: beamer
#+BEAMER_THEME: Dresden
#+BEAMER_COLOR_THEME: beaver
# #+BEAMER_HEADER: \titlegraphic{\includegraphics[height=1.2cm]{../img/logo_inf.pdf} \hfill \includegraphics[height=1.0cm]{../img/gppd-logo.png} \hfill \includegraphics[height=1.0cm]{./../img/ERAD.png}}
#+BEAMER_HEADER: \titlegraphic{ \hfill \includegraphics[height=1.1cm]{./../img/logo_inf.png} \includegraphics[height=1.1cm]{../img/capes.jpg} \hfill \includegraphics[height=0.9cm]{../img/fapergs.jpg} \hfill \includegraphics[height=0.9cm]{./../img/cnpq.png} \hfill \includegraphics[height=0.9cm]{./../img/ERAD.png}}
#+BEAMER_HEADER: \institute{Instituto de Informática PPGC - UFRGS}
#+BEAMER_HEADER: \setbeamertemplate{navigation symbols}{}
#+BEAMER_HEADER: \setbeamertemplate{footline}[page number]
#+BEAMER_HEADER: \setbeamertemplate{headline} { \begin{beamercolorbox}[colsep=1.5pt]{upper separation line head} \end{beamercolorbox} \begin{beamercolorbox}{section in head/foot}  \vskip2pt\insertnavigation{\paperwidth}\vskip2pt \end{beamercolorbox} \begin{beamercolorbox}[colsep=1.5pt]{lower separation line head}  \end{beamercolorbox} }
#+OPTIONS: toc:nil        (no default TOC at all)
#+LATEX_HEADER: \usepackage[backend=bibtex]{biblatex}
#+LATEX_HEADER: \bibliography{../paper/refs}
#+BEAMER_HEADER: \setbeamertemplate{mini frames}{}
#+STARTUP: overview indent
#+TAGS: noexport(n) deprecated(d) Marcelo(m) Lucas(l)
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+PROPERTY: header-args :eval never-export

* Roteiro de apresentação                                          :noexport:
Adicionar anotações e comentários sobre detalhes da apresentação
aqui. 
* Introdução 
** Roteiro
#+BEGIN_EXPORT latex
\Large
\begin{itemize}
\item \textbf{Introdução}
\vfill
\item \textbf{Background}
\vfill
\item \textbf{Metodologia}
\vfill
\item \textbf{Resultados}
\vfill
\item \textbf{Conclusão}
\end{itemize}
\normalsize
#+END_EXPORT
** Introdução
#+LaTeX: \vfill
- A programação baseada em tarefas nos permite descrever uma
  aplicação paralela como um Grafo Acíclico Dirigido (DAG).
#+LaTeX: \vfill
- Esse paradigma de programação possui uma camada entre a aplicação
  e os recursos computacionais: A *camada de runtime*
#+LaTeX: \vfill
     #+BEGIN_CENTER     
     #+ATTR_LaTeX: width=\textwidth
     [[./../img/runtime.pdf]]
     #+END_CENTER

- Essas facilidades oferecidas pelo sistema de runtime vem juntamente
  com um *sobrecusto* adicionado à aplicação, podendo afetar o seu
  desempenho  

** Objetivos
*** A block                                           :B_ignoreheading:BMCOL:
:PROPERTIES:
:BEAMER_col: 0.8
:END:
Existem *diversas* bibliotecas oferecem superte a programação
baseada em tarefas e muitas opções de *sistemas de runtime*
  - Bibliotecas: OpenMP, StarPU
  - Runtimes: GCC/libgomp, LLVM/libomp, CLANG/libkomp 
Runtimes podem ter um impacto diferente sobre o desempenho da
aplicação. Assim, dada uma *mesma aplicação*, nossos objetivos são:  
  - Comparar o escalonamento das tarefas
  - Observar a ociosidade dos trabalhadores
  - Identificar anomalias nas bibliotecas avaliadas 
#   - Observar a ociosidade dos trabalhadores dos runtime 
*** A block                                           :B_ignoreheading:BMCOL:
:PROPERTIES:
:BEAMER_col: 0.2
:END:
#+BEGIN_center
#+ATTR_LaTeX: :height 0.35\textwidth :center
[[./../img/starpu.png]]


\bigskip
\bigskip
#+ATTR_LaTeX: :height 0.4\textwidth :center
[[./../img/llvm.png]]


\bigskip
\bigskip
#+ATTR_LaTeX: :height 0.82\textwidth :center
[[./../img/gcc.png]]
#+END_center
* Background
** Fatoração QR por Blocos

- A fatoração QR é utilizada para resolver sistemas de equações como o
  problema de mínimos quadrados
   
- Este pseudocódigo representa o algoritmo de fatoração QR usando
  quatro rotinas da *biblioteca LAPACK*:

#+BEGIN_CENTER    
#+ATTR_LaTeX: :height 0.4\textwidth :center
[[./../img/pseudo.png]]
#+END_CENTER

** Paralelismo de Tarefas Para fatoração QR Densa  

- O pseudocódigo gera o seguinte DAG associado a estrutura da matriz
  do problema

  #+BEGIN_center
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/blockqr_0.pdf]]
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/DAG_0.pdf]]
  #+END_center

** Paralelismo de Tarefas Para fatoração QR Densa  

- O pseudocódigo gera o seguinte DAG associado a estrutura da matriz
  do problema 

  #+BEGIN_center
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/blockqr_1.pdf]]
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/DAG_1.pdf]]
  #+END_center

** Paralelismo de Tarefas Para fatoração QR Densa  

- O pseudocódigo gera o seguinte DAG associado a estrutura da matriz
  do problema

  #+BEGIN_center
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/blockqr_2.pdf]]
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/DAG_2.pdf]]
  #+END_center
** Paralelismo de Tarefas Para fatoração QR Densa  

- O pseudocódigo gera o seguinte DAG associado a estrutura da matriz
  do problema

  #+BEGIN_center
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/blockqr_4.pdf]]
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/DAG_3.pdf]]
  #+END_center

** Paralelismo de Tarefas Para fatoração QR Densa  

- O pseudocódigo gera o seguinte DAG associado a estrutura da matriz
  do problema

  #+BEGIN_center
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/blockqr_5.pdf]]
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/DAG_5.pdf]]
  #+END_center
** Paralelismo de Tarefas Para fatoração QR Densa  

- O pseudocódigo gera o seguinte DAG associado a estrutura da matriz
  do problema

  #+BEGIN_center
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/blockqr_5.pdf]]
  #+ATTR_LaTeX: :height 0.45\textwidth :center
  [[./../img/DAG_9.pdf]]
  #+END_center

* Metodologia  
** Metodologia de Coleta
- Projeto Experimental:
  - fatores: 
    - tamanho da matriz: $8192\times8192$
    - tamanho do bloco: potências de 2 entre [32, 512]
  - repetições:
    - $5\times$ para a avaliação do makespan
    - $1\times$ para a coleta do rastro das execuções
- Plataformas:
#+name: tab:plataformas
#+attr_latex: :float t :placement [!htb] :font \tiny
|-------+----------------------------------+--------------------+------------|
| <l>   | <l>                              | <l>                | <l>        |
| *Nome*  | *CPU*                              | *L1/L2/LLC*          | *RAM*        |
|-------+----------------------------------+--------------------+------------|
| =draco= | $2 \times 8$ Xeon E5 2640 v2 2.5GHz   | 32KB/256KB/20MB    | 64GB DDR3  |
| =cei=   | $2 \times 12$ Xeon Silver 4116 2.1GHz | 32KB/1024KB/16.5MB | 93GB DDR4  |
| =hype=  | $2 \times 10$ Xeon E5 2650 v3 2.3GHz  | 32KB/256KB/25MB    | 128GB DDR4 |
|-------+----------------------------------+--------------------+------------|
- /Runtimes/:
#+name: tab:versoes
#+attr_latex: :float t :placement [!htb] :font \tiny
|----------------+-----------+------------------------+------------------------------|
| <l>            | <l>       | <l>                    | <l>                          |
| *Identificador*  | *Fonte*     | *ABI/API Utilizada*      | *Versão*                       |
|----------------+-----------+------------------------+------------------------------|
| libgomp_{GCC}     |           | OpenMP/GCC             | =8.3.0=                        |
| libomp_{LLVM}     |           | OpenMP/LLVM            | =6.0.0=                        |
| KStar_{StarPU}    | Diretivas | StarPU (/LWS scheduler/) | =master=\xfeff_{=bf6af54e57bad130=} |
| LIBKOMP_{libgomp} | OpenMP    | OpenMP/LIBKOMP-LLVM    | =master=\xfeff_{=32781b6dab10b1b5=} |
| LIBKOMP_{libomp}  |           | OpenMP/LIBKOMP-GCC     | =master=\xfeff_{=32781b6dab10b1b5=} |
|----------------+-----------+------------------------+------------------------------|
| StarPU         | Nativo    | StarPU (/LWS scheduler/) | =1.3.1=                        |
|----------------+-----------+------------------------+------------------------------|


* Resultados
** Resultados Experimentais e Observações
- Diferenças de tempo de execução em função do /runtime/
#+name: fig:makespan
#+attr_latex: :float t :placement [!htb]
[[../img/makespan-all.png]]
- Conclusões:
  - comportamento se preserva entre plataformas @@latex:{\tiny@@(cei, draco, hype)@@latex:}@@
  - runtime kstar_starpu destoa
  - libkomp_clang é muito instável 
  # pois as vezes nao termina
** Resultados Experimentais e Observações
- Análise de Ociosidade por Trabalhador
  - focaremos na plataforma cei com o tamanho de bloco 64
    - grande número de tarefas estressa a capacidade de escalonamento dos runtimes
  #+name: fig:idleness
  #+attr_latex: :float t :placement [!htb]
  [[../img/idleness-all-cei.png]]
- Conclusões:
  - libkomp_clang e kstar_{StarPU} apresentam ociosidade média acima de
    90% 
  - libgomp_{GCC}, libomp_{LLVM} e StarPU mantém ociosidade compatível
** Resultados Experimentais e Observações
- Comparação do Escalonamento entre os três /runtimes/
  - início da tarefa ~dgeqrt~ (primeira de cada iteração)
#+name: fig:dgeqrt
#+attr_latex: :float t :placement [!htb]
[[../img/dgeqrt-start-cei.png]]

- Conclusões:
  - todas iniciam no 1º segundo de execução
    - exceto kstar_starpu e StarPU
  - kstar_{starpu} inicia quase instantaneamente \to possível anomalia no
    rastreamento ou na implementação.

* Conclusões
** Conclusões
- Analise do desempenho e comportamento de 5 runtimes com uma fatoração QR 
  - tempo de duração das tarefas incompatível com ociosidade e /makespan/
     - libgomp_{GCC}, libomp_{LLVM} e libkomp
  - KStar e libkomp não obtiveram bom desempenho com grão pequeno
- suspeita de que kstar_starpu não está respeitando as dependências
  entre tarefas
- Trabalhos futuros:
  - implementar a verificação da solução obtida pela execução
  - adicionar o runtime OmpSs
  - incluir diferentes arquiteturas de processador

** Referências
#+latex: \nocite{*}
#+latex: \bibliographystyle{sbc}


** Obrigado!
   #+BEGIN_EXPORT latex
   \vfill
    \centering
    \linebreak
    \Huge{\textbf{Perguntas?}}
    \linebreak
    \normalsize
    \vfill
    {hcpsilva,marcelo.miletto,vgpinto,schnorr}@inf.ufrgs.br
    \linebreak
    \vfill
   #+END_EXPORT
   Link do repositório que contém os dados utilizados no trabalho:
   \url{https://gitlab.com/hcpsilva/companion-erad-2020}

   #+BEGIN_center
     \vfill
     \hfill 
     #+ATTR_LaTeX: :height 0.14\textwidth :center
     [[./../img/capes.jpg]]
     \hfill 
     #+ATTR_LaTeX: :height 0.14\textwidth :center
     [[./../img/fapergs.jpg]]
     \hfill
     #+ATTR_LaTeX: :height 0.14\textwidth :center
     [[./../img/cnpq.png]]
     \hfill 
     #+ATTR_LaTeX: :height 0.14\textwidth :center
     [[./../img/logo_inf.png]]
   #+END_center

